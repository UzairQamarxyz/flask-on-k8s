security:
  enabled: true
  existingSecret: "elasticsearch-secret"
  tls:
    restEncryption: true
    autoGenerated: true

master:
  replicaCount: 1
  extraRoles:
    - data
    - ingest

  # Increase the Java Heap Size (e.g., to 1 Gibibyte)
  heapSize: "1g"

  # Also increase the pod's overall memory and CPU limits
  resources:
    requests:
      cpu: "500m"
      memory: "1.5Gi"
    limits:
      cpu: "1" # Allow up to 1 full CPU core
      memory: "2Gi"

  # Mount the kibana-secret so the script can read the password
  extraVolumeMounts:
    - name: kibana-password-volume
      mountPath: /mnt/secrets/kibana-password
      subPath: kibana-password
      readOnly: true
  extraVolumes:
    - name: kibana-password-volume
      secret:
        secretName: kibana-secret

  # This hook updates the `kibana_system` user's password after elasticsearch has started running
  # Script has been minified because for some very strange reason, it wasn't working with multiline
  lifecycleHooks:
    postStart:
      exec:
        command:
          - "/bin/bash"
          - "-c"
          - >
            { set -ex; echo '--- postStart Hook Log ---'; echo "Timestamp: $(date)"; ELASTIC_PASS_FILE="/opt/bitnami/elasticsearch/secrets/elasticsearch-password"; KIBANA_PASS_FILE="/mnt/secrets/kibana-password"; echo 'Waiting for Elasticsearch API...'; while ! curl -s -k 'https://localhost:9200' > /dev/null; do echo 'API not ready, sleeping 5s...'; sleep 5; done; echo 'API is up. Syncing kibana_system password.'; curl_output=$(curl -s -k -w '\n%{http_code}' -X POST -u "elastic:$(cat ${ELASTIC_PASS_FILE})" 'https://localhost:9200/_security/user/kibana_system/_password' -H 'Content-Type: application/json' -d"{\"password\":\"$(cat ${KIBANA_PASS_FILE})\"}"); if [ "$(printf '%s' "$curl_output" | tail -n1)" = "200" ]; then echo 'SUCCESS: Password synced with HTTP 200.'; else echo 'ERROR: Failed to sync password. Full response:'; printf '%s\n' "$curl_output"; exit 1; fi; } &> /tmp/post-start-hook.log

  persistence:
    enabled: true
    storageClass: "local-storage"
    size: 10Gi
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

data:
  replicaCount: 0
ingest:
  enabled: false
coordinating:
  replicaCount: 0
